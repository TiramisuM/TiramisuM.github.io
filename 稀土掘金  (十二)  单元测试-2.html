<html>
<head>
  <title>稀土掘金  (十二) : 单元测试-2</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <meta name="application-data:corenote-hostUUID" content="C8940BC2-A53C-4B55-B59C-4779464BC778"/>
  <meta name="application-data:corenote-localUUID" content="FBE9FAD5-B1F0-43CD-8554-C535113B602D"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1301"/>
<h1>稀土掘金  (十二) : 单元测试-2</h1>

<div>
<span><div>本文将介绍以下内容：</div><ol><li>iOS开发中添加单元测试的方法。</li><li>如何写单元测试用例及用例组。</li><li>介绍单元测试的一些基础概念。</li></ol><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">本篇作为重构的例子，假设了一个视频网站的电影点播系统，每次点击播放就会收取费用，按电影种类不同，时段不同，则收费不同，最终计算出顾客的总消费，并计算积分。这个例子的类关系比较清晰易懂，用OC语言实现，iOS开发的童鞋看起来会比较亲切，心急的童鞋可以跳过源码部分，先看后面添加单元测试的部分，需要了解细节时再回头看源码。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">系统包含一个电影类，顾客类，及点播类，类关系如下图所示：</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image.png" type="image/png" data-filename="Image.png"/><br/></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 16px;">电影类</span></div><div>typedef NS_ENUM(NSUInteger, MovieEnum) {</div><div>    MovieEnumChildrens = 2,</div><div>    MovieEnumRegular = 0,</div><div>    MovieEnumNewRelease = 1</div><div>};</div><div>@class Movie;</div><div>@interface Movie : NSObject</div><div>@property(nonatomic, copy) NSString *title;</div><div>@property(nonatomic) int priceCode;</div><div>- (id)initWithTitle:(NSString *)title</div><div>          priceCode:(int)priceCode;</div><div>@end</div><div>#import &quot;Movie.h&quot;</div><div>@implementation Movie</div><div>- (id)initWithTitle:(NSString *)title</div><div>            priceCode:(int)priceCode {</div><div>    self = [super init];</div><div>    if (self) {</div><div>        _title = title;</div><div>        _priceCode = priceCode;</div><div>    }</div><div>    return self;</div><div>}</div><div>@end</div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 16px;">点播类：</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">点播类定义了点播行为，关心点播了什么电影，及点播的时段，这些都影响最终收取的费用。</span></div><div>port typedef NS_ENUM(NSUInteger, TimePeriodEnum) {</div><div>    TimePeriodEnumWorkDaytime = 1,</div><div>    TimePeriodEnumWorkNight = 2,</div><div>    TimePeriodEnumWeekend = 3</div><div>};</div><div>@class Movie;</div><div>@interface Demand : NSObject</div><div>@property(nonatomic) Movie *movie;</div><div>@property(nonatomic, assign) int timePeriod;</div><div>- (id)initWithMovie:(Movie *)movie</div><div>         timePeriod:(TimePeriodEnum)timePeriod;</div><div>@end</div><div>#import &quot;Demand.h&quot;</div><div>#import &quot;Movie.h&quot;</div><div>@implementation Demand</div><div>- (id)initWithMovie:(Movie *)movie</div><div>         timePeriod:(TimePeriodEnum)timePeriod {</div><div>    self = [super init];</div><div>    if (self) {</div><div>        _movie = movie;</div><div>        _timePeriod = timePeriod;</div><div>    }</div><div>    return self;</div><div>}</div><div>@end</div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 16px;">顾客类</span></div><div>#import @class Demand;</div><div>@interface Customer : NSObject</div><div>- (id)initCustomerWithName:(NSString *)name;</div><div>- (void)addDemand:(Demand *)demand;</div><div>- (NSString *)statement;</div><div>@end</div><div>#import &quot;Customer.h&quot;</div><div>#import &quot;Demand.h&quot;</div><div>#import &quot;Movie.h&quot;</div><div>@interface Customer () {</div><div>    NSString *_name;</div><div>    NSMutableArray *_demands;</div><div>}</div><div>@end</div><div>@implementation Customer</div><div>- (id)initCustomerWithName:(NSString *)name {</div><div>    self = [super init];</div><div>    if (self) {</div><div>        _name = name;</div><div>    }</div><div>    return self;</div><div>}</div><div>- (void)addDemand:(Demand *)demand {</div><div>    if (!_demands) {</div><div>        _demands = [[NSMutableArray alloc] init];</div><div>    }</div><div>    [_demands addObject:demand];</div><div>}</div><div>- (NSString *)statement {</div><div>    double totalAmount = 0;</div><div>    int frequentDemandPotnts = 0;</div><div>    NSMutableString *result = [NSMutableString stringWithFormat:@&quot;%@的点播清单\\\\n&quot;, _name];</div><div>    for (Demand *aDemand in _demands) {</div><div>        double thisAmount = 0;</div><div>        根据不同电影定价：</div><div>        switch (aDemand.movie.priceCode) {</div><div>            case MovieEnumRegular:</div><div>                thisAmount += 2; 普通电影2元一次</div><div>                break;</div><div>            case MovieEnumNewRelease:</div><div>                thisAmount += 3; 新电影3元一次</div><div>                break;</div><div>            case MovieEnumChildrens:</div><div>                thisAmount += 1.5; 儿童电影1.5元一次</div><div>        }</div><div>        根据不同时段定价：</div><div>        if (aDemand.timePeriod == TimePeriodEnumWorkDaytime)</div><div>            thisAmount *= 1.0; 工作日全价</div><div>        else</div><div>            if (aDemand.timePeriod == TimePeriodEnumWeekend) {</div><div>                thisAmount *= 0.5; 周末半价</div><div>            }</div><div>            else</div><div>                if (aDemand.timePeriod == TimePeriodEnumWorkNight){</div><div>                    thisAmount *= 1.5; 下班1.5倍</div><div>                }</div><div>        frequentDemandPotnts++;</div><div>        周末点播新片积分翻倍：</div><div>        if ((aDemand.movie.priceCode == MovieEnumNewRelease) &amp;&amp;</div><div>            aDemand.timePeriod == TimePeriodEnumWeekend) {</div><div>            frequentDemandPotnts++;</div><div>        }</div><div>        [result appendFormat:@&quot;\\\\t%@\\\\t%@ 元\\\\n&quot;, aDemand.movie.title, @(thisAmount)];</div><div>        totalAmount += thisAmount;</div><div>    }</div><div>    [result appendFormat:@&quot;费用总计 %@ 元\\\\n&quot;, @(totalAmount).stringValue];</div><div>    [result appendFormat:@&quot;获得积分 %@&quot;, @(frequentDemandPotnts).stringValue];</div><div>    return result;</div><div>}</div><div>@end</div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 18px;">准备测试工具</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">这里选用的是XCTest，它是Xcode8中内置的测试框架，使用起来非常简单，分以下两种情况为项目添加测试：</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 16px;">1. 新建工程时添加单元测试：</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [1].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">新建时添加单元测试</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 16px;">2.为已有工程添加单元测试</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">Xcode8中添加的步骤与前几代有所不同:</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [2].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">添加Target</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [3].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">用关键词test快速找到Unit Testing bundle</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [4].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">添加好单元测试后的工程结构</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 18px;">添加第一个测试</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">第一个测试是很重要的，它决定了我们后面测试的思路和方向，这里以需要什么测什么为指导原则，从结果出发，所以先来看下基本的点播需求：</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">工作日点播一部普通影片，收费2元，积一分。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">根据以上需求描述，我们在RefactorDemoTests.m添加测试方法：</span></div><div>- (void)testStatement_Regular {</div><div>    Movie *matrixMovie1 = [[Movie alloc] initWithTitle:@&quot;黑客帝国1&quot;</div><div>                                             priceCode:MovieEnumRegular];</div><div>    Demand *aDemand1 = [[Demand alloc] initWithMovie:matrixMovie1</div><div>                                          timePeriod:TimePeriodEnumWorkDaytime];</div><div>    顾客租赁一部：</div><div>    Customer *aCustomer = [[Customer alloc] initCustomerWithName:@&quot;溪石&quot;];</div><div>    [aCustomer addDemand:aDemand1];</div><div>    XCTAssertTrue([@&quot;溪石的点播清单\\\\n&quot;</div><div>                   @&quot;\\\\t黑客帝国1\\\\t2 元\\\\n&quot;</div><div>                   @&quot;费用总计 2 元\\\\n&quot;</div><div>                   @&quot;获得积分 1&quot;</div><div>                   isEqualToString:[aCustomer statement]],</div><div>                   @&quot;测试点播一部普通电影&quot;);</div><div>}</div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">这个测试用例中，顾客“溪石”点播了一部老片《黑客帝国1》，由于是工作日，因此按原价收取，并积1分，详细细节看Cutomer类源码中的方法statement()。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">按快捷键?U，运行测试，发现测试报错了：</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [5].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">第一次运行测试报错了</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">仔细检查发现，statment()的实现中，总价与单位没有空一格，斟酌后觉得还是空一格比较清晰，于是修改后，再次按快捷键?U运行测试，测试通过：</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [6].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">测试通过了</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">在单元测试中，绿色表示测试通过，红色表示测试失败，已经成为业界标准，XCTest遵循了这一规则。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 18px;">测试用例组</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">通过第一个例子，我们知道了测试用例总是以test开头，作为约定俗成，凡是test开头的方法，都会被XCTest框架自动运行，下面我们添加对周末点播优惠的测试：</span></div><div>- (void)testStatement_Weekend {</div><div>    Movie *matrixMovie2 = [[Movie alloc] initWithTitle:@&quot;黑客帝国2-重装上阵&quot;</div><div>                                             priceCode:MovieEnumRegular];</div><div>    Demand *aDemand2 = [[Demand alloc] initWithMovie:matrixMovie2</div><div>                                          timePeriod:TimePeriodEnumWeekend];</div><div>    Customer *aCustomer = [[Customer alloc] initCustomerWithName:@&quot;溪石&quot;];</div><div>    [aCustomer addDemand:aDemand2];</div><div>    XCTAssertTrue([@&quot;溪石的点播清单\\\\n&quot;</div><div>                   @&quot;\\\\t黑客帝国2-重装上阵\\\\t1 元\\\\n&quot;</div><div>                   @&quot;费用总计 1 元\\\\n&quot;</div><div>                   @&quot;获得积分 1&quot;</div><div>                   isEqualToString:[aCustomer statement]],</div><div>                  @&quot;测试点播一部普通电影，周末半价&quot;);</div><div>}</div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">这个测试用例除了电影名称不一样外，只是将点播时段由工作日改为了周末，以此判断计算规则是否正确。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">这时，我们已经有两个测试用例了，为了加快测试速度，打开Xcode左侧第5项的测试导航面板，可以单独指定一个用例运行，注意图中标记处的图标变化：</span></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [7].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">单独运行一个测试用例</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">如此，我们可以将statement需要考虑的返回情况都写成一个个都测试用例（这里就不一一列举了，童鞋们可以自行实现，有问题可以评论中提出，虽然我不一定会回答），可以确保报表算法满足全部需求。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 18px;">单元测试和功能测试的差别</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">功能测试的目的是保证整个软件包能正常工作，它面向的对象是客户，保障软件功能符合客户的要求的质量，当然这类工作应该交由喜爱找bug的专业测试部门去处理，他们会用与开发截然不同的工具，并且不关心实现的细节（这就是你与测试人员老是话不投机的原因）。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">而单元测试关注实现的细节，它的目标对象是一个类，一个方法，是我们开发人员用来验证代码是否有实现异常的工具，因此写单元测试时总是寻找那些可能未处理的边界。</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 18px;">测试循环</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">从上面的简单用例中，我们能明显看到以下通用步骤：</span></div><ol><li>准备测试数据。</li><li>调用目标API</li><li>验证输出和行为</li></ol><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><img src="稀土掘金  (十二)  单元测试-2_files/Image [8].png" type="image/png" data-filename="Image.png"/><br/></div><div style="text-align: center; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">测试循环</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em; font-size: 18px;">小结</span></div><div style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph: true; margin-top: 1em; margin-bottom: 1em;">本文通过一个电影点播系统的例子，演示了以下内容：</span></div><ol><li>iOS开发中添加单元测试框架XCTest。</li><li>用test方法组织单元测试用例及用例组，即可统一运行，也可单独运行。</li><li>介绍单元测试的一些基础概念，了解单元测试的目标，及测试循环。</li></ol><div><br/></div><div style="font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="direction: ltr; font-family: Menlo; color: rgb(79, 129, 189); margin-top: 1em; margin-bottom: 1em; unicode-bidi: embed; font-size: 10.5pt; -en-paragraph: true; border-width: 100%; font-weight: bold;">笔记整理：Edison</span></div><div style="direction: ltr; font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="direction: ltr; font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em; border-width: 100%; font-weight: bold; color: rgb(79, 129, 189); unicode-bidi: embed;">联系方式：QQ：277593 （笔记意见建议可加此Q，专人更新此笔记）；</span></div><div style="direction: ltr; font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="direction: ltr; font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em; border-width: 100%; color: rgb(79, 129, 189); unicode-bidi: embed;"> </span></div><div style="font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="direction: ltr; font-family: Menlo; color: rgb(79, 129, 189); margin-top: 1em; margin-bottom: 1em; unicode-bidi: embed; font-size: 10.5pt; -en-paragraph: true; border-width: 100%; font-weight: bold;">注：小道途径获取到的笔记，无法自动更新，请谅解！(笔记平均每月更新一次，祝各位都能拿到心仪的offer)</span><span style="direction: ltr; font-family: Menlo; color: rgb(79, 129, 189); margin-top: 1em; margin-bottom: 1em; unicode-bidi: embed; font-size: 10.5pt; -en-paragraph: true; border-width: 100%;"> </span></div><div><br/></div></span>
</div></body></html> 