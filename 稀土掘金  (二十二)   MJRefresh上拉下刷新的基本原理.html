<html>
<head>
  <title>稀土掘金  (二十二) :  MJRefresh上拉下刷新的基本原理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <meta name="application-data:corenote-hostUUID" content="C8940BC2-A53C-4B55-B59C-4779464BC778"/>
  <meta name="application-data:corenote-localUUID" content="7CECAD27-FDED-4D1D-901F-5D0BEC0F6DEA"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="897"/>
<h1>稀土掘金  (二十二) :  MJRefresh上拉下刷新的基本原理</h1>

<div>
<span><div><span style="font-size: 18px;">状态</span></div><ul><li>Idle 闲置状态<br/><br/></li><li>pulling 松开就可以进行刷新的状态<br/><br/></li><li>refreshing 正在刷新状态<br/><br/></li></ul><div><span style="font-size: 18px;">初始状态：</span></div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image.png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;">header：Idle</div><div><br/></div><div style="text-align: left;">footer：Idle</div><div><br/></div><div><span style="font-size: 18px;">header的状态变化</span></div><div><br/></div><div>header在拖动中显示出来：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [1].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;">拖拽下拉时使header开始出现在屏幕上</div><div><br/></div><div style="text-align: left;">header开始出现 -&gt; header完全出现在屏幕上：Idle -&gt; Pulling</div><div><br/></div><div>header完全出现 -&gt; header部分出现在屏幕上：Pulling -&gt; Idle</div><div><br/></div><div>拖曳结束时（松手时）：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [2].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;">这时是在Pulling状态松手，所以状态由：Pulling -&gt; Refreshing</div><div><br/></div><div style="text-align: left;">如果是在Idle状态下松手，状态不改变。</div><div><br/></div><div><span style="font-size: 18px;">footer的状态变化</span></div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [3].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div>将要出现footer，此时footer状态为Idle</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [4].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;">footer由开始出现 -&gt; footer完全出现：Idle -&gt; Pulling</div><div><br/></div><div style="text-align: left;">footer由完全出现 -&gt; footer部分出现：Pulling -&gt; Idle</div><div><br/></div><div>拖曳结束时（松手时）：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [5].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;">这是在Pulling状态下松的手，所以状态由：Pulling -&gt; Refreshing</div><div><br/></div><div style="text-align: left;">如果是在Idle状态下松的手，状态不变。</div><div><br/></div><div><span style="font-size: 18px;">header和footer的实现</span></div><div><br/></div><div><span style="font-size: 16px;">初始位置确定：</span></div><div><br/></div><div>从原始状态可以看出：</div><div><br/></div><div>header是scrollView的subView，它的frame.y为-header.frame.height。</div><div><br/></div><div>footer也是scrollView的subView，它的frame.y分为两种情况：</div><div><br/></div><ul><li>当contentSize.height &gt; scrollView.frame.height时，footer.frame.y为contentSize.height<br/><br/></li><li>当contentSize.height &lt; scrollView.frame.height时，footer.frame.y为scrollView.frame.height<br/><br/></li></ul><div>总而言之footer一定在scrollView的下方。</div><div><br/></div><div>上面是最简单的情况分析，可是现实中往往是下面这样：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [6].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;">以上的示意图可以设想一下，一个tableViewController嵌入在navigationController中，navigationController又嵌入在tabbarController中。此时tableViewController的tableView的contentInset属性为(64,0,49,0)，contentOffset为(0,-64)。64是状态栏加导航栏的高度，49是tabbar的高度。这是tableViewController默认设的一些值。</div><div><br/></div><div style="text-align: left;">因此添加footer时要考虑oringinalInsets，把</div><div><br/></div><ul><li>当contentSize.height &lt; scrollView.frame.height时，footer.frame.y为scrollView.frame.height<br/><br/></li></ul><div>改为：</div><div><br/></div><ul><li>当contentSize.height &lt; scrollView.frame.height时，footer.frame.y为scrollView.frame.height - originalInsets.top - originalInsets.bottom<br/><br/></li></ul><div>下面临界值的确定都要考虑originalInsets</div><div><br/></div><div><span style="font-size: 18px;">临界值确定</span></div><div><br/></div><div>确定了初始的位置后，要确定状态之间变换的临界线，通过KVO，监听scrollView的contentOffset的变化。</div><div><br/></div><div><span style="font-size: 16px;">header临界值：</span></div><div><br/></div><ul><li>contentOffset.y &lt; -originalInsets.top时，才开始显示header<br/><br/></li><li>contentOffset.y &lt;= -originalInsets.top - header.frame.size.height时，才完全显示header<br/><br/></li></ul><div><span style="font-size: 16px;">footer的临界值：</span></div><div><br/></div><div>当contentSize.height大于showHeight时：</div><div><br/></div><ul><li>contentOffset.y &gt; scrollView.frame.size.height - showHeight - originalInsets.top时才开始显示footer。<br/><br/></li><li>contentOffset.y &gt; scrollView.frame.size.height - showHeight - originalInsets.top + footer.frame.size.height时才完全显示footer<br/><br/></li></ul><div>当contentSize.height小于showHeight时：</div><div><br/></div><ul><li>contentOffset.y &gt; -originalInsets.top时就开始显示footer。<br/><br/></li><li>contentOffset.y &gt; -originalInsets.top + footer.frame.size.height时才完全显示footer。<br/><br/></li></ul><div><span style="font-size: 18px;">悬浮状态的实现</span></div><div><br/></div><div><span style="font-size: 16px;">header的悬浮</span></div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div><div>2</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.contentInsets.top = header.frame.size.height + originalInsets.top</div><div>scrollView.contentOffset.y = - (scrollView.contentInsets.top)</div></td></tr></tbody></table><div><span style="font-size: 16px;">header的隐藏</span></div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div><div>2</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.contentInset.top = originalInsets.top</div><div>scrollView.contentOffset.y = -(scrollView.contentInsets.top)</div></td></tr></tbody></table><div><span style="font-size: 16px;">footer的悬浮</span></div><div><br/></div><div>当contentSize.height大于showHeight时：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [7].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div><div>2</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.contentInsets.bottom = footer.frame.size.height + originalInsets.bottom</div><div>scrollView.contentOffset.y = contentSize.height - showHeight - originalInsets.top + footer.frame.size.height</div></td></tr></tbody></table><div>当contentSize.height小于showHeight时：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [8].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.contentInsets.bottom = bottom + showHeight - contentSize.height</div></td></tr></tbody></table><div>可以理解成初始的contentOffset.y为-originalInsets.top，然后向上移动了footer.frame.size.height：</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.contentOffset.y = -originalInsets.top + footer.frame.size.height</div></td></tr></tbody></table><div><span style="font-size: 16px;">footer的隐藏</span></div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollVIew.contentInsets.bottom = originalInsets.bottom</div></td></tr></tbody></table><div>当contentSize.height &gt; showHeight时：</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.contentOffset.y = contentSize.height - showHeight - originalInsets.top</div></td></tr></tbody></table><div>当contentSize.height &lt; showHeight时：</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.conentOffset.y = -originalInsets.top</div></td></tr></tbody></table><div><span style="font-size: 18px;">UIScrollView属性详解：</span></div><div><br/></div><div><span style="font-size: 16px;">坐标系正方向：</span></div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [9].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;">屏幕快照 2016-12-02 15.22.01.png</div><div><br/></div><div style="text-align: left;"><span style="font-size: 16px;">ContentOffset的表示：</span></div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [10].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;">屏幕快照 2016-12-02 15.22.13.png</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [11].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div style="text-align: left;"><span style="font-size: 16px;">ContentInsets的表示：</span></div><div><br/></div><div style="text-align: left;">contentInsets并不影响contentSize:</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [12].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div>contentInsets影响contentOffset：</div><div><br/></div><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [13].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div>上图的contentOffset为</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>(0, 0)</div></td></tr></tbody></table><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [14].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div>上图的contentOffset为</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>(-contentInsets.left, -contentInsets.top)</div></td></tr></tbody></table><div style="text-align: center;"><img src="稀土掘金  (二十二)   MJRefresh上拉下刷新的基本原理_files/Image [15].png" type="image/png" data-filename="Image.png"/><br/></div><div><br/></div><div style="text-align: center;"><br/></div><div><br/></div><div>上图的contentOffset为</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>(contentSize.width - scrollView.frame.size.width + contentInsets.right, contentSize.height - scrollView.frame.size.height + contentInsets.bottom)</div></td></tr></tbody></table><div>其实contentInsets就是为scrollView提供了更多的可停留空间，切记要把弹簧效果开启，否则在contentSize小于scrollView.frame时scrollView无法拉动。</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div><div>2</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>scrollView.alwaysBounceVertical = YES;</div><div>self.scrollView.alwaysBounceHorizontal = YES;</div></td></tr></tbody></table><div>在没有设置contentInsets的情况下，scrollView的停留范围为：</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div><div>2</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>contentOffset.x: 0 -&gt; max(contentSize.width - scrollView.frame.width, 0)</div><div>contentOffset.y: 0 -&gt; max(contentSize.height - scrollView.frame.height, 0)</div></td></tr></tbody></table><div>在有contentInsets的情况下，scrollView的停留范围为：</div><div><br/></div><table cellpadding="0" style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>1</div><div>2</div></td><td style="border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div>contentOffset.x: -contentInsets.left -&gt; max(contentSIze.width - scrollView.frame.size.width) + contentInsets.right</div><div>contentOffset.y: -contentInsets.top -&gt; max(contentSIze.height - scrollView.frame.size.height) + contentInsets.bottom</div></td></tr></tbody></table><div><a href="https://github.com/lyxia/LYXRefreshProject">demo</a>地址</div><div><br/></div><div><br/></div><div><br/></div><div><span style="direction: ltr; font-family: SimSun; color: rgb(79, 129, 189); margin-top: 1em; margin-bottom: 1em; unicode-bidi: embed; font-size: 10.5pt; -en-paragraph: true; border-width: 100%; font-weight: bold;">笔记整理：Edison</span></div><div style="direction: ltr; font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="direction: ltr; font-family: SimSun; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em; border-width: 100%; font-weight: bold; color: rgb(79, 129, 189); unicode-bidi: embed;">联系方式：QQ：277593 （笔记意见建议可加此Q，专人更新此笔记）；</span></div><div style="direction: ltr; font-family: Menlo; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em;"><span style="direction: ltr; font-family: SimSun; font-size: 10.5pt; -en-paragraph: true; margin-top: 1em; margin-bottom: 1em; border-width: 100%; color: rgb(79, 129, 189); unicode-bidi: embed;"> </span></div><div><span style="direction: ltr; font-family: SimSun; color: rgb(79, 129, 189); margin-top: 1em; margin-bottom: 1em; unicode-bidi: embed; font-size: 10.5pt; -en-paragraph: true; border-width: 100%; font-weight: bold;">注：小道途径获取到的笔记，无法自动更新，请谅解！(笔记平均每月更新一次，祝各位都能拿到心仪的offer)</span><span style="direction: ltr; font-family: SimSun; color: rgb(79, 129, 189); margin-top: 1em; margin-bottom: 1em; unicode-bidi: embed; font-size: 10.5pt; -en-paragraph: true; border-width: 100%;"> </span></div><div><br/></div></span>
</div></body></html> 